# Phase 3 要件仕様 — ブレインストーミング結果

> **Status**: ブレインストーミング完了 → 設計フェーズ待ち
> **Date**: 2026-02-13
> **Base**: REQUIREMENTS-v2.0.md Phase 3 + UI刷新要件
> **Scope**: Phase 3.0〜3.3（UI刷新 + 収益化）

---

## 1. Phase 3 全体構成

Phase 3 を **UI先行型** の4サブフェーズに分割する。

```
Phase 3.0 — UI刷新（Verge/Wired風リデザイン）
Phase 3.1 — OAuth認証（Google, GitHub）
Phase 3.2 — 全文翻訳アクセス + 原文/翻訳比較表示
Phase 3.3 — Stripe課金（月額500円）
```

### Phase 4 — パーソナルサイト (NCaaS)

Phase 3 完了後に実装。詳細は §9 を参照。

### Phase 5以降に延期

- Newsletter配信（n8n連携が必要、コア機能安定後に実装）
- 独自分析・コメント機能

---

## 2. Phase 3.0 — UI刷新

### 2.1 デザイン方針

| 項目 | 決定内容 |
|------|----------|
| 参考サイト | The Verge / Wired |
| テーマ | ダーク / ライト / システム追従の3モード |
| デフォルトテーマ | ダーク |
| フォント（英文） | Inter |
| フォント（日本語） | Noto Sans JP |
| アクセントカラー | 淡い赤系（カテゴリ色分け等に使用） |
| アニメーション | CSS のみ（Framer Motion 不使用） |

### 2.2 記事一覧ページ

#### ユーザーストーリー

- ユーザーとして、最新のテックニュースを一目で把握できる、視覚的にリッチな一覧ページを見たい
- ユーザーとして、重要な記事が目立つレイアウトで表示されることを期待する
- ユーザーとして、カテゴリごとに色分けされたバッジで記事を素早く分類したい

#### 機能要件

| 要素 | 仕様 |
|------|------|
| ヒーロー記事 | 全幅表示、大きなOG画像 + オーバーレイテキスト（タイトル、要約） |
| グリッド | カードサイズに差異（大・中・小）、Bento Grid的なレイアウト |
| カテゴリバッジ | アクセントカラー（淡い赤系）で色分け |
| ホバーエフェクト | CSS transition（shadow + subtle scale） |
| 無限スクロール | 既存機能を維持 |
| SSEリアルタイム更新 | 既存機能を維持 |
| プレミアムバッジ | 有料記事にはプレミアムアイコン/バッジを表示 |

### 2.3 記事詳細ページ

#### ユーザーストーリー

- ユーザーとして、翻訳されたニュース記事を美しいタイポグラフィで快適に読みたい
- ユーザーとして、記事の読了時間を事前に把握したい
- ユーザーとして、長い記事では目次で素早くナビゲートしたい
- ユーザーとして、スクロール進捗を視覚的に確認したい

#### 機能要件

| 要素 | 仕様 |
|------|------|
| 読了時間表示 | 文字数から自動計算（日本語: 約500文字/分） |
| スクロールプログレスバー | ページ上部に固定表示 |
| 目次（TOC） | 見出し（h2, h3）から自動生成、サイドバーに配置（長い記事のみ） |
| タイポグラフィ | 行間・文字間を調整、最大幅制限で読みやすさ確保 |
| リード画像 | 記事上部に大きく表示（OG画像） |
| メタ情報 | 著者、公開日、ソース名、カテゴリバッジ |

### 2.4 ダークモード

#### ユーザーストーリー

- ユーザーとして、テック系サイトらしいダークテーマで快適に読みたい
- ユーザーとして、ライトテーマ/ダークテーマ/OS設定追従から選べるようにしたい
- ユーザーとして、テーマ選択が次回訪問時も維持されてほしい

#### 機能要件

| 要素 | 仕様 |
|------|------|
| モード数 | 3（ダーク / ライト / システム追従） |
| デフォルト | ダーク |
| 切り替えUI | ヘッダーにトグルボタン |
| 永続化 | localStorage で保存 |
| 実装方式 | CSS変数 + Tailwind dark: variant |
| フラッシュ防止 | `<script>` タグで初期ロード前にテーマ適用（FOUC防止） |

### 2.5 ヘッダー/ナビゲーション

| 要素 | 仕様 |
|------|------|
| スティッキーヘッダー | スクロール時に固定 |
| カテゴリナビ | カテゴリ一覧を目立つ位置に配置 |
| テーマトグル | ヘッダー右側に配置 |
| ログインボタン | Phase 3.1で追加（ヘッダー右側） |

### 2.6 共通トランジション

| 対象 | 仕様 |
|------|------|
| カードホバー | `transition: shadow 200ms, transform 200ms` |
| テーマ切り替え | `transition: background-color 300ms, color 300ms` |
| タブ切り替え | `transition: opacity 200ms` |
| ページロード | フェードイン（`@keyframes fadeIn`） |

---

## 3. Phase 3.1 — OAuth認証

### 3.1 ユーザーストーリー

- ユーザーとして、Google または GitHub アカウントで簡単にログインしたい
- ユーザーとして、ログイン状態が維持されてほしい（リフレッシュトークン）
- ユーザーとして、自分のプロフィール情報を確認したい

### 3.2 機能要件

| 項目 | 仕様 |
|------|------|
| プロバイダー | Google, GitHub（2つのみ） |
| トークン | JWT RS256。アクセス: 15分、リフレッシュ: 7日 |
| APIエンドポイント | `POST /auth/login`, `POST /auth/refresh`, `GET /users/me` |
| DBテーブル | users（REQUIREMENTS-v2.0.md §4.4 準拠） |
| フロントエンド | ログイン/ログアウトUI、ユーザーアバター表示 |

### 3.3 受け入れ基準

- [ ] Google OAuth でログインできる
- [ ] GitHub OAuth でログインできる
- [ ] アクセストークンの自動リフレッシュが動作する
- [ ] ログイン状態がページリロード後も維持される
- [ ] `/users/me` でプロフィール情報が返る
- [ ] ログアウトでトークンが無効化される

---

## 4. Phase 3.2 — 全文翻訳 + 比較表示

### 4.1 ユーザーストーリー

- 有料ユーザーとして、プレミアム記事の全文翻訳を読みたい
- ユーザーとして、原文と翻訳をタブで切り替えて比較したい
- 無料ユーザーとして、プレミアム記事の要約は読めるが全文は読めないことを理解したい

### 4.2 課金モデル

| 項目 | 仕様 |
|------|------|
| 無料コンテンツ | すべての記事の要約（summary_ja）+ 通常記事の全文翻訳 |
| 有料コンテンツ | 管理者/n8nが「プレミアム」フラグをつけた記事の全文翻訳（body_translated） |
| プレミアムフラグ | articles テーブルに `is_premium BOOLEAN DEFAULT FALSE` を追加 |
| 判定ロジック | `is_premium = true` の記事 → 有料ユーザーのみ `body_translated` を返却 |

### 4.3 APIエンドポイント

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | `/articles/{id}/full` | JWT必須 | 全文翻訳取得（プレミアム記事は有料ユーザーのみ） |

### 4.4 原文/翻訳タブ切り替えUI

| 項目 | 仕様 |
|------|------|
| 表示方式 | タブ切り替え（「翻訳」「原文」の2タブ） |
| デフォルト | 翻訳タブ |
| 切り替え | 同一エリア内で opacity transition |
| レスポンシブ | 全デバイスでタブ切り替え（統一UI） |
| 無料ユーザー向け | プレミアム記事では要約のみ表示 + 有料プランへの誘導バナー |

### 4.5 RLS（Row Level Security）

| 項目 | 仕様 |
|------|------|
| 粒度 | フィールドレベル（body_translated） |
| 実装 | API層で制御（プレミアム記事 × 無料ユーザー → body_translated を除外） |
| PostgreSQL RLS | 将来的にDB層でも enforcement する選択肢を残す |

### 4.6 受け入れ基準

- [ ] 通常記事は全ユーザーが全文翻訳を読める
- [ ] プレミアム記事は有料ユーザーのみ全文翻訳を読める
- [ ] 無料ユーザーがプレミアム記事を開くと要約 + アップグレード誘導が表示される
- [ ] 原文/翻訳のタブ切り替えが正常に動作する
- [ ] 一覧ページでプレミアム記事にバッジが表示される

---

## 5. Phase 3.3 — Stripe課金

### 5.1 ユーザーストーリー

- ユーザーとして、月額500円でプレミアム記事を読めるプランに加入したい
- ユーザーとして、Stripeで安全に支払いたい
- ユーザーとして、いつでもプランをキャンセルしたい

### 5.2 機能要件

| 項目 | 仕様 |
|------|------|
| 価格 | 月額500円（税込） |
| 決済 | Stripe Checkout Session |
| プラン管理 | Stripe Customer Portal でユーザー自身が管理 |
| Webhook | `checkout.session.completed`, `customer.subscription.updated`, `customer.subscription.deleted` |
| ユーザーテーブル拡張 | `stripe_customer_id`, `subscription_status`, `subscription_end_date` |

### 5.3 受け入れ基準

- [ ] Stripe Checkout で月額500円のサブスクリプションを購入できる
- [ ] 購入後、プレミアム記事の全文翻訳が読めるようになる
- [ ] Stripe Customer Portal でプラン管理（キャンセル等）ができる
- [ ] Webhook でサブスクリプション状態が自動更新される
- [ ] サブスクリプション期限切れで自動的にアクセスが制限される

---

## 6. 技術的な考慮事項

### 新規依存パッケージ（想定）

| パッケージ | 用途 | Phase |
|-----------|------|-------|
| python-jose[cryptography] | JWT RS256 | 3.1 |
| authlib | OAuth 2.0 クライアント | 3.1 |
| stripe | Stripe SDK | 3.3 |
| @fontsource/inter | Inter フォント | 3.0 |
| @fontsource/noto-sans-jp | Noto Sans JP | 3.0 |

### DBマイグレーション

| Phase | テーブル変更 |
|-------|-------------|
| 3.1 | `users` テーブル新規作成 |
| 3.2 | `articles` に `is_premium BOOLEAN DEFAULT FALSE` 追加 |
| 3.3 | `users` に `stripe_customer_id`, `subscription_status`, `subscription_end_date` 追加 |

### フロントエンド変更範囲

| Phase | 影響ファイル |
|-------|-------------|
| 3.0 | 全ページ・全コンポーネント（テーマ、レイアウト、フォント） |
| 3.1 | Header, 新規LoginPage, 新規ProfilePage |
| 3.2 | ArticleDetail（タブ切り替え追加）、ArticleCard（プレミアムバッジ） |
| 3.3 | 新規PricingPage, UserProfile（プラン表示）、PaywallBanner |

---

## 7. 未解決事項（設計フェーズで決定）

| # | 項目 | 決定時期 |
|---|------|----------|
| 1 | カラーパレットの具体的な値（淡い赤系のHex値、ダーク/ライト各色） | Phase 3.0 設計時 |
| 2 | Bento Grid の具体的なカードサイズ比率 | Phase 3.0 設計時 |
| 3 | JWT リフレッシュトークンの保存場所（httpOnly cookie vs localStorage） | Phase 3.1 設計時 |
| 4 | OAuth コールバックURL構成 | Phase 3.1 設計時 |
| 5 | プレミアム記事の判定ロジック（n8nフロー vs 管理画面） | Phase 3.2 設計時 |
| 6 | Stripe Webhook のエンドポイント設計 | Phase 3.3 設計時 |

---

## 8. 次のステップ

1. **Phase 3.0 設計**: `/sc:design` で UI刷新の詳細設計（カラーパレット、コンポーネント設計、レイアウト仕様）
2. **Phase 3.1 設計**: OAuth + JWT の認証フロー設計
3. **Phase 3.2 設計**: 全文翻訳API + RLS + タブUI設計
4. **Phase 3.3 設計**: Stripe連携設計（3プラン: Free / Premium / Pro）
5. **Phase 4 設計**: マルチテナント・パーソナルサイト設計

---

## 9. Phase 4 — News Curation as a Service (NCaaS)

### 9.1 コンセプト

課金ユーザーに「自分専用のニュースサイト」を提供するマルチテナントプラットフォーム。
プラットフォームが提供するのは **美しいフロントエンド（Verge/Wired風UI）と APIによるコンテンツ管理機能** であり、翻訳・要約等のLLM処理はプラットフォームには組み込まない。

**本質**: APIで自動登録できるCMS + 美しいフロントエンド

```
┌─────────────────────────────────────────────────┐
│           News Curation Platform                 │
│                                                  │
│  メインサイト (news.example.com)                  │
│  ├── 運営者のテックニュース（n8n + Ollama で翻訳）│
│  ├── Free: 要約閲覧                              │
│  └── Premium: 全文翻訳                           │
│                                                  │
│  テナントサイト (user1.news.example.com)          │
│  ├── ユーザーがAPIで投入したコンテンツ            │
│  ├── 共通記事のインポート（オプション）           │
│  ├── フルカスタマイズ（テーマ、ロゴ、ドメイン）   │
│  └── APIフルコントロール                         │
└─────────────────────────────────────────────────┘
```

### 9.2 3プラン構成

| プラン | 月額 | 主な機能 |
|--------|------|----------|
| **Free** | 無料 | メインサイトの記事閲覧（要約のみ） |
| **Premium** | 500円 | 全文翻訳アクセス（プレミアム記事含む） |
| **Pro** | 1,000円 | パーソナルサイト + APIフルコントロール + 全Premium機能 |

### 9.3 Pro プラン機能要件

#### ユーザーストーリー

- Proユーザーとして、自分専用のサブドメイン（user1.news.example.com）でニュースサイトを持ちたい
- Proユーザーとして、APIで自分のコンテンツをプログラマティックに管理したい
- Proユーザーとして、サイトのテーマ色、ロゴ、サイト名を自由にカスタマイズしたい
- Proユーザーとして、メインサイトの共通テックニュースをインポートするかどうか選びたい
- Proユーザーとして、独自ドメイン（CNAME）を設定したい

#### パーソナルサイト機能

| 項目 | 仕様 |
|------|------|
| サブドメイン | `{username}.news.example.com` — ユーザー登録時に自動生成 |
| カスタムドメイン | CNAME設定による独自ドメイン対応 |
| サイト名 | ユーザーが自由に設定 |
| ロゴ | 画像アップロードまたはURL指定 |
| テーマカラー | プライマリ色、アクセント色をカラーピッカーで設定 |
| ダーク/ライトモード | メインサイトと同様の3モード対応 |
| レイアウト | メインサイトと同じVerge/Wired風UI（テーマ色のみ変更） |

#### APIアクセス

| 項目 | 仕様 |
|------|------|
| 認証 | テナントスコープのAPIキー（ユーザーがダッシュボードで発行） |
| 記事CRUD | POST/GET/PUT/DELETE `/api/v1/articles` |
| ソース管理 | POST/GET/PUT/DELETE `/api/v1/sources` |
| インジェスト | POST `/api/v1/ingest`（本文抽出） |
| レート制限 | プランに応じた制限値 |
| ドキュメント | Swagger UI / ReDoc でAPI仕様を公開 |

#### 共通記事インポート

| 項目 | 仕様 |
|------|------|
| オプション | ユーザーがダッシュボードで有効/無効を切り替え |
| 対象 | メインサイトの公開記事（summary_ja + source_url） |
| 表示 | テナントサイトのフィードにインポート記事が混在 |
| 識別 | インポート記事には「共通ニュース」バッジを表示 |

### 9.4 マルチテナント・アーキテクチャ（方針）

| 項目 | 方針 |
|------|------|
| データ分離 | 共有DB + `tenant_id` カラム（スキーマ分離は過剰） |
| ルーティング | Next.js middleware でサブドメインからテナントを解決 |
| テーマ | CSS変数をテナント設定から動的に注入 |
| API分離 | `/api/v1/` 配下にテナントスコープのエンドポイント |
| ストレージ | テナントのロゴ画像等は S3 互換ストレージ（将来） |

### 9.5 DBスキーマ拡張（概要）

| テーブル | 用途 |
|----------|------|
| `tenants` | テナント情報（サブドメイン、サイト名、テーマ設定、カスタムドメイン） |
| `tenant_api_keys` | テナントごとのAPIキー管理 |
| `articles` に `tenant_id` 追加 | 記事のテナント所属（NULL = メインサイト） |
| `sources` に `tenant_id` 追加 | ソースのテナント所属 |
| `users` に `tenant_id` + `plan` 追加 | ユーザーのプラン・テナント紐付け |

### 9.6 受け入れ基準

- [ ] Proプラン購入後、サブドメインが自動生成される
- [ ] テナントサイトにアクセスすると、カスタマイズされたテーマで表示される
- [ ] テナントAPIキーで記事をCRUDできる
- [ ] 共通記事のインポートを有効/無効に切り替えられる
- [ ] サイト名、ロゴ、テーマカラーをダッシュボードから変更できる
- [ ] カスタムドメイン（CNAME）が設定できる
- [ ] テナント間でデータが完全に分離されている

### 9.7 未解決事項（Phase 4 設計時に決定）

| # | 項目 |
|---|------|
| 1 | テナントあたりの記事数上限 |
| 2 | APIレート制限の具体的な値 |
| 3 | ロゴ画像のストレージ（S3, Cloudflare R2, ローカル等） |
| 4 | カスタムドメインのSSL証明書管理（Let's Encrypt自動化） |
| 5 | テナント管理ダッシュボードのUI設計 |
| 6 | メインサイトとテナントサイトのNext.jsインスタンス構成（共有 vs 分離） |
| 7 | テナント削除時のデータ処理ポリシー |
| 8 | Pro → Premium ダウングレード時のテナントサイト処理 |
